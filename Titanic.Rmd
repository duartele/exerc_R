---
title: "Titanic"
author: "Leandro Duarte"
date: "25/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, echo=FALSE, eval=TRUE}
# Use getwd() para ver se está no diretorio correto
df<-read.csv2("titanic.csv",colClasses = c("factor", "factor","factor","numeric","integer","integer","numeric", "factor","factor")) #Como importei a base - com os tipos corretos

# Usar attach(df) se não quiser ficar digitando df$ em cada variável

```
## Estudo sobre a base Titanic

1. Introdução

O objetivo primordial deste estudo é aplicar os conhecimentos aprendidos em Estatística Computacional com o professor Luís Machado (MECD), apresentando os passos e comandos utilizados nos softwares R e PSPP (ou SPSS). Além disso, foi ambicionado fazer uma Análise Descritiva (Uni e Muldimensional), Estimações (Pontual e Intervalar) e, por fim, apresentar alguns modelos para a previsão da variável resposta.

Para cumprir tais objetivos, foi escolhido trabalhar com a base de dados Titanic porque ela apresenta uma quantidade razoável de variáveis explicativas quantitativas (ordinais e nominais) e qualitativas (discretas e contínuas). Ademais, referida base é proveniente de um acidente histórico real que até hoje é relembrado pelas pessoas, as quais assistiram aos filmes e foram (ou desejaram ir) ao museu do Titanic, em Belfast.

Com efeito, o **RMS Titanic** foi um navio luxuoso construído para ser 'inafundável'. Partiu dia 10 de abril de 1912 com 2224 pessoas (passageiros e tripulantes) e o acidente ocorreu dia 15 de abril daquele ano, acarretando provavelmente em **mais de 1500 mortes** (foi estimado que o total de mortes está entre 1490 e 1635) [(ver Wikipédia)](https://en.wikipedia.org/wiki/Titanic).

Considerando que a base que temos acesso possui informações sobre `r nrow(df)` passageiros, ou seja, praticamente todos os existentes (2224 - 688 tripulantes ~= base), as medidas calculadas seriam populacionais e não amostrais, o que inviabilizaria fazer inferências ou construir modelos. Então, todo o exposto será uma abstração para focarmos nas técnicas computacionais e estatísticas.

Dito isto, consideraremos que estamos interessados em prever se um passageiro sobreviveu ao acidente, tendo posse de algumas informações sobre ele, ou seja, a variável resposta será "survived", caracterizada pela flag 1 se o passageiro sobreviveu ao acidente ou 0 em caso contrário. A proporção de sobreviventes na base foi de `r round(table(df$survived)[2]/nrow(df)*100,2)`%.

Pela Análise da Descritiva, percebemos que a proporção de mulheres que sobreviveram ao acidente foi de 72,75%, enquanto que a dos homens foi apenas de 19,10%. Também percebemos que as pessoas que viajaram na primeira classe tiveram uma maior taxa de sobrevivência (de 61,92% contra 25,53% dos que viajaram na terceira classe). Pessoas que embarcaram no porto "C" (Cherbourg) também possuíram uma proporção maior de sobrevivência (55,56% contra 33,56% nos outros portos).

Em contrapartida, a variável sibsp não pareceu contribuir para entendermos melhor a variável resposta, pois a maioria dos valores é 0 e ainda não há uma associação linear entre ela e a variável resposta. No tocante à variável parch, também verificamos que a maioria dos valores é 0, mas podemos tentar fazer uma dicotomia entre possui (pais ou filhos) ou não possui. Através da idade, percebemos que as crianças tiveram maior chance de sobrevivência, mas esta variável apresenta muitos valores faltante (mais de 20% da base) e, ainda, para adultos a variável não parece contribuir para explicar a variável resposta. Quanto os passageiros que pagaram mais caro nas passagens também tiveram maior chance de sobrevivência, mas esta variável está bastante correlacionada com a variável pclass.  

Vimos, ainda, que o intervalo de confiança de 95% de probabilidade obtido pela amostra para obter a proporção de sobreviventes é de [0,35;0,40]. Considerando que a proporção de sobreviventes informada no site da Wikipédia está entre [0,2648;0,3525], podemos supor que os tripulantes tiveram menos chance de sobrevivência, pois só consideramos os passageiros neste trabalho. Outra possibilidade é que a chance de sobrevivência dos poucos passageiros que não fizem parte da amostra seja ainda menor que a dos pertencentes na amostra.

Por fim, foi apresentado um modelo de regressão logística, o qual utilizou as variáveis xpto e que apresentou uma acurácia de 75%, um modelo de KNN, o qual mostrou uma acurácia de 70% quando escolhido o hiperparâmetro de 5 vizinhos e também uma árvore de decisão.

2. Primeiras Análises

    2.1 Dicionário de variáveis

+ **survived**: Sobrevivência (ou não) dos passageiros. Possíveis valores: 0 (morreu) ou 1 (sobreviveu);

+ **pclass**: Classe do Bilhete. Possíveis valores: 1(primeira), 2(segunda) ou 3 (terceira);
`
+ **sex**: Gênero do passageiro. Possíveis valores: female (feminino) ou male(masculino);

+ **age**: Idade em anos. Possíveis valores: Para crianças menores de um ano, a idade pode assumir um valor contínuo (no intervalo  ]0,1[). Para mais velhos que isso, usa-se o valores discretos  {1,2,3...}. Quando tem o valor da forma xx.5 é porque a idade da pessoa foi estimada.

+ **sibsp**: Número de irmãos e/ou esposos a bordo. Possíveis valores: {0,1,2,3...};

+ **parch**: Número de pais e/ou filhos a bordo. Possíveis valores: {0,1,2,3...};

+ **fare**: Valor da tarifa paga. Possíveis valores: ]0,+∞[;

+ **embarked**: Porto de Embarque. Possíveis valores: C (Cherbourg), Q (Queenstown) ou S (Southampton);

+ **death**: Morte (ou não) do passageiro. Possíveis valores: 0 (não morreu) ou 1(morreu). Esta variável será descartada porque foi obtida pela variável **survived**.

Observe o tipo das variáveis e depois os primeiros registros em forma tabular:

```{r, echo=TRUE, eval=TRUE}
df<-subset(df, select=-death)
str(df)
head(df)
```

Antes de analisarmos as variáveis, vale observar a tabela resumo, que apresenta as frequências das variáveis qualitativas, medidas descritivas nas variáveis quantitativas e a quantidade de registros faltantes em cada atributo:

```{r}
summary(df)
```

Percebemos pela tabela resumo que cada categoria das variáveis qualitativas possuem ao menos 10% de representantes, o que garante alguma representatividade das categorias.

Quanto às informações faltantes, a única variável alarmante é a idade (20% dos registros) - ver seção 2.3.2 **Age** para ver algumas formas de contornar este problema.

Após essas considerações preliminares, podemos passar para as Análises Descritivas. 

    2.2 Variáveis Qualitativas
    2.2.1 Variáveis Qualitativas Nominais
    
**Sex** (female ou male)

```{r, echo=TRUE}

label.pie<-c("Female","Male")
freq<-round(table(df$sex)/nrow(df)*100,2)
label.pie<-paste(label.pie,freq)
label.pie<-paste(label.pie,"%",sep="")
pie(x=table(df$sex), labels=label.pie, col = c("lightpink", "lightblue"))

```

Das `r  nrow(df)` observações, temos `r table(df$sex)[1]` mulheres (`r round(table(df$sex)[1]/nrow(df)*100,2)`%) e
`r table(df$sex)[2]` homens (`r round(table(df$sex)[2]/nrow(df)*100,2)`%), sem
valores faltantes, portanto.
No gráfico a seguir, veremos para cada uma dessas categorias o comportamento da variável resposta.


```{r, echo=TRUE}
barplot(table(df$survived,df$sex), xlab="Sobrevivência por Sexo", ylab="Frequência",
        legend.text = TRUE, beside=FALSE)


```


Pela apreciação desse gráfico, percebe-se que a proporção de sobrevivência das mulheres é bem superior a dos homens (72,75% contra 19,09%), indicando assim que a variável sexo pode ajudar a explicar a sobrevivência de um passageiro.

**Embarked** (C - Cherbourg, Q - Queenstown ou S - Southampton)

```{r, echo=TRUE}

label.pie<-c("Na", "C","Q", "S")
freq<-round(table(df$embarked)/nrow(df)*100,2)
label.pie<-paste(label.pie,freq)
label.pie<-paste(label.pie,"%",sep="")
pie(x=table(df$embarked), labels=label.pie)

```

Percebemos que o Porto de Southampton é o mais frequente e que só possuímos 2 valores faltantes. Quanto ao comportamento desta variável em relação a resposta temos:

```{r, echo=TRUE}

barplot(table(df$survived,df$embarked), xlab="Sobrevivência por Porto de Embarque", ylab="Frequência",
        legend.text = TRUE, beside=TRUE)

```

Pela apreciação do gráfico, percebemos que apenas no porto C a proporção de sobreviventes foi maior que a de falecidos. Além disso, temos que a proporção de sobreviventes no porto Q está muito próxima da do S.

2.2.2 Variáveis Qualitativas Ordinais

**Pclass** (1, 2 ou 3)

```{r, echo=TRUE}

label.pie<-c("Primeira","Segunda", "Terceira")
freq<-round(table(df$pclass)/nrow(df)*100,2)
label.pie<-paste(label.pie,freq)
label.pie<-paste(label.pie,"%",sep="")
pie(x=table(df$pclass), labels=label.pie)

```

Observando o gráfico acima, percebemos que a Terceira classe é a mais frequente. Quanto a proporção de sobreviventes, temos:


```{r, echo=TRUE}
barplot(table(df$survived,df$pclass), xlab="Sobrevivência por Classe de Embarque", ylab="Frequência",
        legend.text = TRUE, beside=TRUE)

```

Temos a sugestão de que quanto pior é a classe menor é a proporção de sobreviência de um passageiro, sendo que houve mais sobreviventes na primeira classe que falecidos.

   2.3 Variáveis Quantitativas
   2.3.1 Variáveis Quantitativas Discretas

**Sibsp** (Número de irmãos e ou esposos)

```{r, echo=TRUE}

layout(matrix(c(1,2),ncol=2))
hist(df$sibsp, freq = TRUE ,ylab = "Frequência", xlab="Número de irmãos ou esposos",main="")
boxplot(df$sibsp)

```

Pelos gráficos acima, perebe-se que a maioria dos passageiros embarcou sozinho ou com apenas um(a) espos(a)(ou irmã(o)). Com efeito, apenas 4,35% dos passageiros possuía 3 ou mais irmãos.
Levando isto em consideração, talvez seja mais interessante pensar nesta variável como se fosse categórica, o que resultaria em:

```{r, echo=TRUE}

barplot(table(df$survived,df$sibsp), xlab="Sobrevivência por número de irmãos", ylab="Frequência",
        legend.text = TRUE, beside=TRUE)

```

Quando olhamos as proporções de sobreviventes, não conseguimos ver uma associação linear. De fato, os que embarcaram sozinhos tiveram menos chance de sobrevivência dos que embarcaram com 1 ou 2 irmãos, porém com 3 ou mais irmãos a proporção de sobrevivência já fica bem baixa. Fazer um agrupamento em 3 conglomerados("não possui", "possui 1 ou 2" e "possui mais de 2") pode até dar uma contribuição na modelagem, mas o resultado não seria interpretativo. Então, talvez esta variável não seja utilizada nos modelos.

**Parch** (Número de pais ou filhos a bordo)

```{r, echo=TRUE}

layout(matrix(c(1,2),ncol=2))
hist(df$parch, freq = TRUE ,ylab = "Frequência", xlab="Número de pais ou filhos",main="")
boxplot(df$parch)

```

Assim como sibsp, a maioria dos passageiros embarcou sozinho ou possuía apenas um ou dois filhos (ou pais). Utilizando o mesmo raciocínio da variável anterior, temos:

```{r, echo=TRUE}

barplot(table(df$survived,df$parch), xlab="Sobrevivência por número de pais ou filhos", ylab="Frequência",
        legend.text = TRUE, beside=TRUE)

```

Aqui parece que há uma associação linear entre número de filhos e proporção de sobrevivência. Porém, como há poucas observações com mais de 2 filhos (1,3%), talvez o único agrupamento que faça sentido seria "não possui" contra "possui".  

   2.3.2 Variáveis Quantitativas Contínuas

**Age**

```{r, echo=TRUE}

layout(matrix(c(1,2),ncol=2))
hist(df$age, freq = TRUE ,ylab = "Frequência", xlab="Idade",main="")
boxplot(df$age)

```

Pela apreciação dos gráficos, percebe-se que as faixas ]20,25] e ]25,30] são mais frequentes, com uma leve assimetria à direita. Para ilustramos nossa assertiva, observe a distribuição da amostra com a comparação de uma curva normal.

```{r}

hist(df$age, freq = FALSE ,ylab = "Frequência", xlab="Idade",main="")
curve(dnorm(x,mean = mean(df$age, na.rm = TRUE),sd=sd(df$age, na.rm = TRUE)),add=TRUE)
rug(df$age)
abline(v=mean(df$age, na.rm = TRUE),col="red")

```

Comparando as distribuições dos que sobreviveram e a dos que faleceram, não conseguimos notar diferenças significativas através de boxplots. Se não, vejamos:

```{r}

boxplot(df$age~df$survived)

```

Porém, utilizando histogramas, percebe-se que crianças e adolescentes tiveram mais chances de sobrevivência. Contudo, eles representam menos de 12% da base, o que poderá inviabilizar o uso desta variável no modelo.

```{r}

mor<-df$age[df$survived==0]
viv<-df$age[df$survived==1]

layout(matrix(c(1,2),ncol=1))
hist(mor, freq = FALSE, breaks = 12, xlab = "Falecidos", main="")
hist(viv, freq = FALSE, col = "lightblue", breaks = 12, xlab = "Sobreviventes", main="")

```

Por fim, observando o comportamento das observações sem valores na variável idade, temos que apenas 73 dos 263 passageiros sobreviveram(27,76%). 

 Como algumas técnicas de modelagem não permitem a utilização de "missings", podemos contornar esse problema de algumas formas:

1. removendo registros faltantes - **quando são poucos** - Aqui não é o caso, pois 20% da base está com valores faltantes;
2. utilizando o valor médio (ou a moda) amostral - quando a variável ainda possa contribuir para explicar a variável resposta - não parede fazer sentido nesta variável, pois a taxa de sobrevivência dos passageiros sem idade indicada é bem baixa;
3. excluíndo a variável do modelo - quando são muitos registros faltantes - 20% da base certamente não é um número pequeno, mas descartar informações de 80% da base por causa desses faltantes parece ser um procedimento muito conservador.

Considerando que essas 3 medidas não se aplicam para a variável idade, podemos agrupar a idade em três conglomerados: 1.Crianças e jovens; 2.Adultos; 3.Sem idade informada. Para essa nova variável (faixa_etaria) considere o seguinte código:

```{r}

calc_faixa_etaria<-function(idade=NA){
  if(is.na(idade)){
    faixa_etaria = "3.Sem idade informada"
  }else if(idade<=15){
    faixa_etaria = "1.Crianças e jovens"
  } else{
    faixa_etaria = "2.Adultos"
  }
}

```





**Fare**

```{r, echo=TRUE}
hist(df$fare)
```

Percebemos que a variável **fare** possui valores mais localizados à esquerda do gráfico. Vale dizer, uma das causas são os valores extremos que estão aumentando a amplitude de cada intervalo ("bins" é o termo em inglês). Antes de fazermos algum ajuste, é de bom alvitre olharmos o comportamento desta variável em relação à resposta.


